From ea132e26e088a4049ad9b35299e964b9af69cc97 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Fri, 2 Jun 2017 14:19:02 -0500
Subject: [PATCH] am335x: split out pruss

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 arch/arm/boot/dts/am335x-bone-common.dtsi          | 16 ----
 arch/arm/boot/dts/am335x-boneblack-audio.dts       |  1 +
 arch/arm/boot/dts/am335x-boneblack-bbb-exp-c.dts   |  1 +
 arch/arm/boot/dts/am335x-boneblack-bbb-exp-r.dts   |  1 +
 arch/arm/boot/dts/am335x-boneblack-bbbmini.dts     |  1 +
 .../boot/dts/am335x-boneblack-cape-bone-argus.dts  |  1 +
 .../arm/boot/dts/am335x-boneblack-roboticscape.dts |  2 +-
 .../dts/am335x-boneblack-wireless-roboticscape.dts |  2 +-
 arch/arm/boot/dts/am335x-boneblack-wireless.dts    |  1 +
 arch/arm/boot/dts/am335x-boneblack.dts             |  1 +
 arch/arm/boot/dts/am335x-boneblue-ArduPilot.dts    |  2 +-
 arch/arm/boot/dts/am335x-boneblue.dts              |  2 +-
 arch/arm/boot/dts/am335x-bonegreen-wireless.dts    |  1 +
 arch/arm/boot/dts/am335x-bonegreen.dts             |  1 +
 arch/arm/boot/dts/am335x-icev2.dts                 |  1 +
 arch/arm/boot/dts/am335x-sancloud-bbe.dts          |  1 +
 arch/arm/boot/dts/am33xx-pruss-rproc.dtsi          | 89 ++++++++++++++++++++++
 arch/arm/boot/dts/am33xx-pruss-uio.dtsi            | 23 ++++++
 arch/arm/boot/dts/am33xx.dtsi                      | 72 -----------------
 19 files changed, 127 insertions(+), 92 deletions(-)
 create mode 100644 arch/arm/boot/dts/am33xx-pruss-rproc.dtsi
 create mode 100644 arch/arm/boot/dts/am33xx-pruss-uio.dtsi

diff --git a/arch/arm/boot/dts/am335x-bone-common.dtsi b/arch/arm/boot/dts/am335x-bone-common.dtsi
index e8b3d58358ac..6559a8029e31 100644
--- a/arch/arm/boot/dts/am335x-bone-common.dtsi
+++ b/arch/arm/boot/dts/am335x-bone-common.dtsi
@@ -416,22 +416,6 @@
 	ti,scale-data-fw = "am335x-bone-scale-data.bin";
 };
 
-&pruss_soc_bus {
-	status = "okay";
-
-	pruss: pruss@4a300000 {
-		status = "okay";
-
-		pru0: pru@4a334000 {
-			status = "okay";
-		};
-
-		pru1: pru@4a338000 {
-			status = "okay";
-		};
-	};
-};
-
 /* the cape manager */
 / {
 	bone_capemgr {
diff --git a/arch/arm/boot/dts/am335x-boneblack-audio.dts b/arch/arm/boot/dts/am335x-boneblack-audio.dts
index cac3626dd611..833afd0d930b 100644
--- a/arch/arm/boot/dts/am335x-boneblack-audio.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-audio.dts
@@ -9,6 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Black";
diff --git a/arch/arm/boot/dts/am335x-boneblack-bbb-exp-c.dts b/arch/arm/boot/dts/am335x-boneblack-bbb-exp-c.dts
index 857c21ea4834..4ddc8650a517 100644
--- a/arch/arm/boot/dts/am335x-boneblack-bbb-exp-c.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-bbb-exp-c.dts
@@ -9,6 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common-no-capemgr.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Black";
diff --git a/arch/arm/boot/dts/am335x-boneblack-bbb-exp-r.dts b/arch/arm/boot/dts/am335x-boneblack-bbb-exp-r.dts
index b834fa2ee098..71d5bd10f411 100644
--- a/arch/arm/boot/dts/am335x-boneblack-bbb-exp-r.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-bbb-exp-r.dts
@@ -9,6 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common-no-capemgr.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Black";
diff --git a/arch/arm/boot/dts/am335x-boneblack-bbbmini.dts b/arch/arm/boot/dts/am335x-boneblack-bbbmini.dts
index adb317ceed7a..c1b9eaf0a543 100644
--- a/arch/arm/boot/dts/am335x-boneblack-bbbmini.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-bbbmini.dts
@@ -10,6 +10,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
+#include "am33xx-pruss-uio.dtsi"
 
 #include <dt-bindings/board/am335x-bbw-bbb-base.h>
 #include <dt-bindings/pinctrl/am33xx.h>
diff --git a/arch/arm/boot/dts/am335x-boneblack-cape-bone-argus.dts b/arch/arm/boot/dts/am335x-boneblack-cape-bone-argus.dts
index cecb0fccc70b..53ef1d5d35b2 100644
--- a/arch/arm/boot/dts/am335x-boneblack-cape-bone-argus.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-cape-bone-argus.dts
@@ -9,6 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common-no-capemgr.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Black";
diff --git a/arch/arm/boot/dts/am335x-boneblack-roboticscape.dts b/arch/arm/boot/dts/am335x-boneblack-roboticscape.dts
index 0d713eec441a..a2c6dc48dcbe 100644
--- a/arch/arm/boot/dts/am335x-boneblack-roboticscape.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-roboticscape.dts
@@ -18,7 +18,7 @@
 #include "am33xx.dtsi"
 #include "am335x-bone-common-no-capemgr.dtsi"
 #include "am335x-bone-common-universal-pins.dtsi"
-/* #include "am33xx-pruss-rproc.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 #include "am335x-roboticscape.dtsi"
 
 / {
diff --git a/arch/arm/boot/dts/am335x-boneblack-wireless-roboticscape.dts b/arch/arm/boot/dts/am335x-boneblack-wireless-roboticscape.dts
index de4bd006ff30..bfaabadd83d0 100644
--- a/arch/arm/boot/dts/am335x-boneblack-wireless-roboticscape.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-wireless-roboticscape.dts
@@ -18,7 +18,7 @@
 #include "am33xx.dtsi"
 #include "am335x-bone-common-no-capemgr.dtsi"
 #include "am335x-bone-common-universal-pins.dtsi"
-/* #include "am33xx-pruss-rproc.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 #include "am335x-boneblack-wl1835.dtsi"
 #include "am335x-roboticscape.dtsi"
 
diff --git a/arch/arm/boot/dts/am335x-boneblack-wireless.dts b/arch/arm/boot/dts/am335x-boneblack-wireless.dts
index 9b39648ef75a..c9de59020099 100644
--- a/arch/arm/boot/dts/am335x-boneblack-wireless.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-wireless.dts
@@ -12,6 +12,7 @@
 #include <dt-bindings/display/tda998x.h>
 #include "am335x-boneblack-wl1835.dtsi"
 /* #include "am335x-bone-jtag.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Black Wireless";
diff --git a/arch/arm/boot/dts/am335x-boneblack.dts b/arch/arm/boot/dts/am335x-boneblack.dts
index e4573689d7df..278072fb1536 100644
--- a/arch/arm/boot/dts/am335x-boneblack.dts
+++ b/arch/arm/boot/dts/am335x-boneblack.dts
@@ -9,6 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 #include <dt-bindings/display/tda998x.h>
 /* #include "am335x-bone-jtag.dtsi" */
 
diff --git a/arch/arm/boot/dts/am335x-boneblue-ArduPilot.dts b/arch/arm/boot/dts/am335x-boneblue-ArduPilot.dts
index ba3892bdf395..5630c6dd5d4a 100644
--- a/arch/arm/boot/dts/am335x-boneblue-ArduPilot.dts
+++ b/arch/arm/boot/dts/am335x-boneblue-ArduPilot.dts
@@ -12,7 +12,7 @@
 #include "am335x-bone-common-no-capemgr.dtsi"
 #include "am335x-bone-common-universal-pins.dtsi"
 #include "am335x-boneblue-wl1835.dtsi"
-/* #include "am33xx-pruss-rproc.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 #define BLUE_IO(x, y) AM33XX_IOPAD((x)*4+0x800, (y)) /* not used anymore */
 
diff --git a/arch/arm/boot/dts/am335x-boneblue.dts b/arch/arm/boot/dts/am335x-boneblue.dts
index 92ed7bf57ac2..c5017029b0d3 100644
--- a/arch/arm/boot/dts/am335x-boneblue.dts
+++ b/arch/arm/boot/dts/am335x-boneblue.dts
@@ -12,7 +12,7 @@
 #include "am335x-bone-common-no-capemgr.dtsi"
 #include "am335x-bone-common-universal-pins.dtsi"
 #include "am335x-boneblue-wl1835.dtsi"
-/* #include "am33xx-pruss-rproc.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 #define BLUE_IO(x, y) AM33XX_IOPAD((x)*4+0x800, (y)) /* not used anymore */
 
diff --git a/arch/arm/boot/dts/am335x-bonegreen-wireless.dts b/arch/arm/boot/dts/am335x-bonegreen-wireless.dts
index f37f39e189ef..5ae5b1a1f0ff 100644
--- a/arch/arm/boot/dts/am335x-bonegreen-wireless.dts
+++ b/arch/arm/boot/dts/am335x-bonegreen-wireless.dts
@@ -11,6 +11,7 @@
 #include "am335x-bone-common.dtsi"
 #include "am335x-bonegreen-wl1835.dtsi"
 /* #include "am335x-bone-jtag.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Green Wireless";
diff --git a/arch/arm/boot/dts/am335x-bonegreen.dts b/arch/arm/boot/dts/am335x-bonegreen.dts
index 647d4bfca84b..254e04805875 100644
--- a/arch/arm/boot/dts/am335x-bonegreen.dts
+++ b/arch/arm/boot/dts/am335x-bonegreen.dts
@@ -10,6 +10,7 @@
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
 /* #include "am335x-bone-jtag.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM335x BeagleBone Green";
diff --git a/arch/arm/boot/dts/am335x-icev2.dts b/arch/arm/boot/dts/am335x-icev2.dts
index 38ff52e8ddc5..3829027cf516 100644
--- a/arch/arm/boot/dts/am335x-icev2.dts
+++ b/arch/arm/boot/dts/am335x-icev2.dts
@@ -14,6 +14,7 @@
 /dts-v1/;
 
 #include "am33xx.dtsi"
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "TI AM3359 ICE-V2";
diff --git a/arch/arm/boot/dts/am335x-sancloud-bbe.dts b/arch/arm/boot/dts/am335x-sancloud-bbe.dts
index a36b04b750d4..ef4186da5d1a 100644
--- a/arch/arm/boot/dts/am335x-sancloud-bbe.dts
+++ b/arch/arm/boot/dts/am335x-sancloud-bbe.dts
@@ -12,6 +12,7 @@
 #include <dt-bindings/interrupt-controller/irq.h>
 #include <dt-bindings/display/tda998x.h>
 /* #include "am335x-bone-jtag.dtsi" */
+#include "am33xx-pruss-rproc.dtsi"
 
 / {
 	model = "SanCloud BeagleBone Enhanced";
diff --git a/arch/arm/boot/dts/am33xx-pruss-rproc.dtsi b/arch/arm/boot/dts/am33xx-pruss-rproc.dtsi
new file mode 100644
index 000000000000..a465cc2928cb
--- /dev/null
+++ b/arch/arm/boot/dts/am33xx-pruss-rproc.dtsi
@@ -0,0 +1,89 @@
+/*
+ * Device Tree Source for AM33XX SoC
+ *
+ * Copyright (C) 2012 Texas Instruments Incorporated - http://www.ti.com/
+ *
+ * This file is licensed under the terms of the GNU General Public License
+ * version 2.  This program is licensed "as is" without any warranty of any
+ * kind, whether express or implied.
+ */
+
+/ {
+	ocp {
+		pruss_soc_bus: pruss_soc_bus@4a326000 {
+			compatible = "ti,am3356-pruss-soc-bus";
+			reg = <0x4a326000 0x2000>;
+			ti,hwmods = "pruss";
+			#address-cells = <1>;
+			#size-cells = <1>;
+			ranges;
+			status = "okay";
+
+			pruss: pruss@4a300000 {
+				compatible = "ti,am3356-pruss";
+				reg = <0x4a300000 0x2000>,
+				      <0x4a302000 0x2000>,
+				      <0x4a310000 0x3000>,
+				      <0x4a326000 0x2000>,
+				      <0x4a32e000 0x31c>,
+				      <0x4a332000 0x58>;
+				reg-names = "dram0", "dram1", "shrdram2", "cfg",
+					    "iep", "mii_rt";
+				#address-cells = <1>;
+				#size-cells = <1>;
+				ranges;
+				status = "okay";
+
+				pruss_intc: intc@4a320000 {
+					compatible = "ti,am3356-pruss-intc";
+					reg = <0x4a320000 0x2000>;
+					reg-names = "intc";
+					interrupts = <20 21 22 23 24 25 26 27>;
+					interrupt-names = "host2", "host3",
+							  "host4", "host5",
+							  "host6", "host7",
+							  "host8", "host9";
+					interrupt-controller;
+					#interrupt-cells = <1>;
+				};
+
+				pru0: pru@4a334000 {
+					compatible = "ti,am3356-pru";
+					reg = <0x4a334000 0x2000>,
+					      <0x4a322000 0x400>,
+					      <0x4a322400 0x100>;
+					reg-names = "iram", "control", "debug";
+					label = "pru0";
+					interrupt-parent = <&pruss_intc>;
+					interrupts = <16>, <17>;
+					interrupt-names = "vring", "kick";
+					status = "okay";
+				};
+
+				pru1: pru@4a338000 {
+					compatible = "ti,am3356-pru";
+					reg = <0x4a338000 0x2000>,
+					      <0x4a324000 0x400>,
+					      <0x4a324400 0x100>;
+					reg-names = "iram", "control", "debug";
+					label = "pru1";
+					interrupt-parent = <&pruss_intc>;
+					interrupts = <18>, <19>;
+					interrupt-names = "vring", "kick";
+					status = "okay";
+				};
+
+				pruss_mdio: mdio@4a332400 {
+					compatible = "ti,davinci_mdio";
+					reg = <0x4a332400 0x90>;
+					clocks = <&dpll_core_m4_ck>;
+					clock-names = "fck";
+					bus_freq = <1000000>;
+					#address-cells = <1>;
+					#size-cells = <0>;
+					status = "disabled";
+				};
+			};
+		};
+	};
+};
diff --git a/arch/arm/boot/dts/am33xx-pruss-uio.dtsi b/arch/arm/boot/dts/am33xx-pruss-uio.dtsi
new file mode 100644
index 000000000000..133a4cc508f5
--- /dev/null
+++ b/arch/arm/boot/dts/am33xx-pruss-uio.dtsi
@@ -0,0 +1,23 @@
+/*
+ * Device Tree Source for AM33XX SoC
+ *
+ * Copyright (C) 2012 Texas Instruments Incorporated - http://www.ti.com/
+ *
+ * This file is licensed under the terms of the GNU General Public License
+ * version 2.  This program is licensed "as is" without any warranty of any
+ * kind, whether express or implied.
+ */
+
+/ {
+	ocp {
+		pruss: pruss@4a300000 {
+			status = "okay";
+			compatible = "ti,pruss-v2";
+			ti,deassert-hard-reset = "pruss", "pruss";
+			reg = <0x4a300000 0x080000>;
+			ti,pintc-offset = <0x20000>;
+			interrupt-parent = <&intc>;
+			interrupts = <20 21 22 23 24 25 26 27>;
+		};
+	};
+};
diff --git a/arch/arm/boot/dts/am33xx.dtsi b/arch/arm/boot/dts/am33xx.dtsi
index cf72e393f5d2..2e1442a7a7fd 100644
--- a/arch/arm/boot/dts/am33xx.dtsi
+++ b/arch/arm/boot/dts/am33xx.dtsi
@@ -976,79 +976,7 @@
 		};
 
 		pruss_soc_bus: pruss_soc_bus@4a326000 {
-			compatible = "ti,am3356-pruss-soc-bus";
-			reg = <0x4a326000 0x2000>;
-			ti,hwmods = "pruss";
-			#address-cells = <1>;
-			#size-cells = <1>;
-			ranges;
 			status = "disabled";
-
-			pruss: pruss@4a300000 {
-				compatible = "ti,am3356-pruss";
-				reg = <0x4a300000 0x2000>,
-				      <0x4a302000 0x2000>,
-				      <0x4a310000 0x3000>,
-				      <0x4a326000 0x2000>,
-				      <0x4a32e000 0x31c>,
-				      <0x4a332000 0x58>;
-				reg-names = "dram0", "dram1", "shrdram2", "cfg",
-					    "iep", "mii_rt";
-				#address-cells = <1>;
-				#size-cells = <1>;
-				ranges;
-				status = "disabled";
-
-				pruss_intc: intc@4a320000 {
-					compatible = "ti,am3356-pruss-intc";
-					reg = <0x4a320000 0x2000>;
-					reg-names = "intc";
-					interrupts = <20 21 22 23 24 25 26 27>;
-					interrupt-names = "host2", "host3",
-							  "host4", "host5",
-							  "host6", "host7",
-							  "host8", "host9";
-					interrupt-controller;
-					#interrupt-cells = <1>;
-				};
-
-				pru0: pru@4a334000 {
-					compatible = "ti,am3356-pru";
-					reg = <0x4a334000 0x2000>,
-					      <0x4a322000 0x400>,
-					      <0x4a322400 0x100>;
-					reg-names = "iram", "control", "debug";
-					label = "pru0";
-					interrupt-parent = <&pruss_intc>;
-					interrupts = <16>, <17>;
-					interrupt-names = "vring", "kick";
-					status = "disabled";
-				};
-
-				pru1: pru@4a338000 {
-					compatible = "ti,am3356-pru";
-					reg = <0x4a338000 0x2000>,
-					      <0x4a324000 0x400>,
-					      <0x4a324400 0x100>;
-					reg-names = "iram", "control", "debug";
-					label = "pru1";
-					interrupt-parent = <&pruss_intc>;
-					interrupts = <18>, <19>;
-					interrupt-names = "vring", "kick";
-					status = "disabled";
-				};
-
-				pruss_mdio: mdio@4a332400 {
-					compatible = "ti,davinci_mdio";
-					reg = <0x4a332400 0x90>;
-					clocks = <&dpll_core_m4_ck>;
-					clock-names = "fck";
-					bus_freq = <1000000>;
-					#address-cells = <1>;
-					#size-cells = <0>;
-					status = "disabled";
-				};
-			};
 		};
 
 		elm: elm@48080000 {
-- 
2.11.0

