From c440c22bd983b867deca2dce35ac81690fd5ff86 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Fri, 21 Oct 2016 11:02:16 -0500
Subject: [PATCH 7/7] bbbw: use wl_en_regualtor

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 .../dts/am335x-boneblack-wireless-emmc-overlay.dts | 14 ++--
 arch/arm/boot/dts/am335x-boneblack-wireless.dts    | 14 +++-
 arch/arm/boot/dts/am335x-boneblack-wl1835.dtsi     | 82 ++++++++++++++--------
 3 files changed, 73 insertions(+), 37 deletions(-)

diff --git a/arch/arm/boot/dts/am335x-boneblack-wireless-emmc-overlay.dts b/arch/arm/boot/dts/am335x-boneblack-wireless-emmc-overlay.dts
index cbab12b..ad1b5ed 100644
--- a/arch/arm/boot/dts/am335x-boneblack-wireless-emmc-overlay.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-wireless-emmc-overlay.dts
@@ -9,8 +9,10 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
-#include "am33xx-overlay-edma-fix.dtsi"
+/* #include "am33xx-overlay-edma-fix.dtsi" */
+/* #include <dt-bindings/display/tda998x.h> */
 #include "am335x-boneblack-wl1835.dtsi"
+/* #include "am335x-bone-jtag.dtsi" */
 
 /* pruss: pick one: */
 
@@ -64,12 +66,8 @@
 };
 
 &cpu0_opp_table {
-	/*
-	 * All PG 2.0 silicon may not support 1GHz but some of the early
-	 * BeagleBone Blacks have PG 2.0 silicon which is guaranteed
-	 * to support 1GHz OPP so enable it for PG 2.0 on this board.
-	 */
-	oppnitro@1000000000 {
-		opp-supported-hw = <0x06 0x0100>;
+	//osd335x
+	opp50@300000000 {
+		status = "disabled";
 	};
 };
diff --git a/arch/arm/boot/dts/am335x-boneblack-wireless.dts b/arch/arm/boot/dts/am335x-boneblack-wireless.dts
index 8fa31ff..d253519 100644
--- a/arch/arm/boot/dts/am335x-boneblack-wireless.dts
+++ b/arch/arm/boot/dts/am335x-boneblack-wireless.dts
@@ -9,7 +9,7 @@
 
 #include "am33xx.dtsi"
 #include "am335x-bone-common.dtsi"
-#include "am33xx-overlay-edma-fix.dtsi"
+/* #include "am33xx-overlay-edma-fix.dtsi" */
 #include <dt-bindings/display/tda998x.h>
 #include "am335x-boneblack-wl1835.dtsi"
 /* #include "am335x-bone-jtag.dtsi" */
@@ -66,6 +66,7 @@
 };
 
 &cpu0_opp_table {
+	//osd335x
 	opp50@300000000 {
 		status = "disabled";
 	};
@@ -116,6 +117,14 @@
 
 &lcdc {
 	status = "okay";
+
+	/* If you want to get 24 bit RGB and 16 BGR mode instead of
+	 * current 16 bit RGB and 24 BGR modes, set the propety
+	 * below to "crossed" and uncomment the video-ports -property
+	 * in tda19988 node.
+	 */
+	blue-and-red-wiring = "straight";
+
 	port {
 		lcdc_0: endpoint@0 {
 			remote-endpoint = <&hdmi_0>;
@@ -132,6 +141,9 @@
 		pinctrl-0 = <&nxp_hdmi_bonelt_pins>;
 		pinctrl-1 = <&nxp_hdmi_bonelt_off_pins>;
 
+		/* Convert 24bit BGR to RGB, e.g. cross red and blue wiring */
+		/* video-ports = <0x234501>; */
+
 		#sound-dai-cells = <0>;
 		audio-ports = <	AFMT_I2S	0x03>;
 
diff --git a/arch/arm/boot/dts/am335x-boneblack-wl1835.dtsi b/arch/arm/boot/dts/am335x-boneblack-wl1835.dtsi
index 82da276..ec6c0e4 100644
--- a/arch/arm/boot/dts/am335x-boneblack-wl1835.dtsi
+++ b/arch/arm/boot/dts/am335x-boneblack-wl1835.dtsi
@@ -2,17 +2,23 @@
 #include <dt-bindings/interrupt-controller/irq.h>
 
 / {
+	wlan_en_reg: fixedregulator@2 {
+		compatible = "regulator-fixed";
+		regulator-name = "wlan-en-regulator";
+		regulator-min-microvolt = <1800000>;
+		regulator-max-microvolt = <1800000>;
+		startup-delay-us= <70000>;
+
+		/* WL_EN */
+		gpio = <&gpio3 9 0>;
+		enable-active-high;
+	};
+
 	leds {
 		pinctrl-names = "default";
 		pinctrl-0 = <&wl18xx_pins>;
 		compatible = "gpio-leds";
 
-		wl18xx_wl_en {
-			label = "wl18xx_wl_en";
-			gpios = <&gpio3 9 GPIO_ACTIVE_HIGH>;
-			default-state = "on";
-		};
-
 		wl18xx_bt_en {
 			label = "wl18xx_bt_en";
 			gpios = <&gpio0 28 GPIO_ACTIVE_HIGH>;
@@ -20,14 +26,6 @@
 		};
 	};
 
-	tibt {
-		compatible = "tibt";
-		nshutdown_gpio = <28>;
-		dev_name = "/dev/ttyS3";
-		flow_cntrl = <1>;
-		baud_rate = <3000000>;
-	};
-
 	btwilink {
 		compatible = "btwilink";
 	};
@@ -37,7 +35,6 @@
 	wl18xx_pins: pinmux_wl18xx_pins {
 		pinctrl-single,pins = <
 			0x128 (PIN_OUTPUT_PULLUP | MUX_MODE7)	/* (K17) gmii1_txd0.gpio0[28] - BT_EN */
-			0x12c (PIN_OUTPUT_PULLDOWN | MUX_MODE7 ) /* (K18) gmii1_txclk.gpio3[9] - WL_EN */
 		>;
 	};
 
@@ -58,10 +55,30 @@
 		>;
 	};
 
+	mmc3_pins_sleep: pinmux_mmc3_pins_sleep {
+		pinctrl-single,pins = <
+			0x13c ( PIN_INPUT_PULLDOWN | MUX_MODE6 ) /* (L15) gmii1_rxd1.mmc2_clk */
+			0x114 ( PIN_INPUT_PULLDOWN | MUX_MODE6 ) /* (J16) gmii1_txen.mmc2_cmd */
+			0x118 ( PIN_INPUT_PULLDOWN | MUX_MODE5 ) /* (J17) gmii1_rxdv.mmc2_dat0 */
+			0x11c ( PIN_INPUT_PULLDOWN | MUX_MODE5 ) /* (J18) gmii1_txd3.mmc2_dat1 */
+			0x120 ( PIN_INPUT_PULLDOWN | MUX_MODE5 ) /* (K15) gmii1_txd2.mmc2_dat2 */
+			0x108 ( PIN_INPUT_PULLDOWN | MUX_MODE5 ) /* (H16) gmii1_col.mmc2_dat3 */
+		>;
+	};
+
 	/* wl18xx card enable/irq GPIOs. */
 	wlan_pins: pinmux_wlan_pins {
 		pinctrl-single,pins = <
-			0x144 ( PIN_INPUT_PULLUP | MUX_MODE7 )  /* (H18) rmii1_refclk.gpio0[29] - WL_IRQ */
+			0x12c (PIN_OUTPUT_PULLDOWN | MUX_MODE7 ) /* (K18) gmii1_txclk.gpio3[9] - WL_EN */
+			0x144 (PIN_INPUT_PULLDOWN | MUX_MODE7 )  /* (H18) rmii1_refclk.gpio0[29] - WL_IRQ */
+		>;
+	};
+
+	/* wl18xx card enable/irq GPIOs. */
+	wlan_pins_sleep: pinmux_wlan_pins_sleep {
+		pinctrl-single,pins = <
+			0x12c (PIN_OUTPUT_PULLDOWN | MUX_MODE7 ) /* (K18) gmii1_txclk.gpio3[9] - WL_EN */
+			0x144 (PIN_INPUT_PULLDOWN | MUX_MODE7 )  /* (H18) rmii1_refclk.gpio0[29] - WL_IRQ */
 		>;
 	};
 
@@ -69,10 +86,19 @@
 		pinctrl-single,pins = <
 			0x134 ( PIN_INPUT_PULLUP | MUX_MODE1 ) 		/* (L17) gmii1_rxd3.uart3_rxd */
 			0x138 ( PIN_OUTPUT_PULLDOWN | MUX_MODE1 )	/* (L16) gmii1_rxd2.uart3_txd */
-			0x148 ( PIN_INPUT | MUX_MODE3 ) 			/* (M17) mdio_data.uart3_ctsn */
+			0x148 ( PIN_INPUT | MUX_MODE3 ) 		/* (M17) mdio_data.uart3_ctsn */
 			0x14c ( PIN_OUTPUT_PULLDOWN | MUX_MODE3 ) 	/* (M18) mdio_clk.uart3_rtsn */
 		>;
 	};
+
+	uart3_pins_sleep: pinmux_uart3_pins_sleep {
+		pinctrl-single,pins = <
+			0x134 (PIN_INPUT_PULLDOWN | MUX_MODE7)	/* (L17) gmii1_rxd3.uart3_rxd */
+			0x138 (PIN_INPUT_PULLDOWN | MUX_MODE7)	/* (L16) gmii1_rxd2.uart3_txd */
+			0x148 (PIN_INPUT_PULLDOWN | MUX_MODE7)	/* (M17) mdio_data.uart3_ctsn */
+			0x14c (PIN_INPUT_PULLDOWN | MUX_MODE7)	/* (M18) mdio_clk.uart3_rtsn */
+		>;
+	};
 };
 
 &mmc3 {
@@ -80,16 +106,15 @@
 		&edma_xbar 13 0 2>;
 	dma-names = "tx", "rx";
 	status = "okay";
-	vmmc-supply = <&vmmcsd_fixed>;
+	vmmc-supply = <&wlan_en_reg>;
 	bus-width = <4>;
-	pinctrl-names = "default";
+	pinctrl-names = "default", "sleep";
 	pinctrl-0 = <&mmc3_pins &wlan_pins &wlbtbuf_pin>;
+	pinctrl-1 = <&mmc3_pins_sleep &wlan_pins_sleep &wlbtbuf_pin>;
 	ti,non-removable;
 	ti,needs-special-hs-handling;
-	//ti,dual-volt;
 	cap-power-off-card;
 	keep-power-in-suspend;
-	//broken-cd;
 
 	#address-cells = <1>;
 	#size-cells = <0>;
@@ -97,10 +122,17 @@
 		compatible = "ti,wl1835";
 		reg = <2>;
 		interrupt-parent = <&gpio0>;
-		interrupts = <29 IRQ_TYPE_LEVEL_HIGH>;
+		interrupts = <29 IRQ_TYPE_EDGE_RISING>;
 	};
 };
 
+&uart3 {
+	pinctrl-names = "default", "sleep";
+	pinctrl-0 = <&uart3_pins_default>;
+	pinctrl-1 = <&uart3_pins_sleep>;
+	status = "okay";
+};
+
 &gpio3 {
 	ls_buf_en {
 		gpio-hog;
@@ -109,9 +141,3 @@
 		line-name = "LS_BUF_EN";
 	};
 };
-
-&uart3 {
-	pinctrl-names = "default";
-	pinctrl-0 = <&uart3_pins_default>;
-	status = "okay";
-};
-- 
2.9.3

